<!-- å±•è§ˆè¯¦æƒ…é¡µ -->
<view class="container">
  <!-- åŠ è½½ä¸­çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{isLoading}}">
    <view class="loading-spinner"></view>
    <view class="loading-text">åŠ è½½å±•è§ˆä¿¡æ¯ä¸­...</view>
  </view>

  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <block wx:else>
    <!-- é¡¶éƒ¨å±•è§ˆä¿¡æ¯åŒº -->
    <view class="header-section {{isHeaderFixed ? 'fixed' : ''}}">
      <!-- å±•è§ˆå¤§å›¾ -->
      <image class="exhibition-banner" src="{{baseUrl}}/file/getPic?name={{exhibition.colPic}}" mode="aspectFill"></image>
      
      <!-- å±•è§ˆåŸºæœ¬ä¿¡æ¯ -->
      <view class="exhibition-info">
        <!-- å±•è§ˆæ ‡é¢˜ -->
        <view class="exhibition-title">{{exhibition.title}}</view>
        
        <!-- å±•è§ˆæ—¶é—´ -->
        <view class="exhibition-meta">
          <image class="meta-icon" src="/images/icons/date.png"></image> 
          <text class="meta-text">{{exhibition.startDate}} - {{exhibition.endDate}}</text>
        </view>
        
        <!-- å±•è§ˆåœ°ç‚¹ -->
        <view class="exhibition-meta">
          <image class="meta-icon" src="/images/icons/location.png"></image> 
          <text class="meta-text">{{exhibition.location || 'ä¸´å±•é¦†1å·å…'}}</text>
        </view>
        
        <!-- å±•è§ˆçŠ¶æ€æ ‡ç­¾ -->
        <view class="status-tag {{exhibition.status}}">
          {{exhibition.status === 'upcoming' ? 'å³å°†å¼€å§‹' : exhibition.status === 'ongoing' ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ'}}
        </view>
      </view>
      
      <!-- å±•è§ˆç®€ä»‹ -->
      <view class="exhibition-intro">
        <view class="section-title">å±•è§ˆç®€ä»‹</view>
        <view class="intro-content {{isIntroFolded ? 'folded' : ''}}">{{exhibition.intro || 'æš‚æ— ç®€ä»‹'}}</view>
        <view class="fold-btn" bindtap="toggleIntro" wx:if="{{exhibition.intro && exhibition.intro.length > 100}}">
          {{isIntroFolded ? 'å±•å¼€' : 'æ”¶èµ·'}}
          <!-- ä½¿ç”¨æ–‡å­—æ›¿ä»£å›¾æ ‡ -->
          <text class="fold-icon-text">{{isIntroFolded ? 'â–¼' : 'â–²'}}</text>
        </view>
      </view>
    </view>

    <!-- æ—¶é—´æ®µé€‰æ‹©åŒº -->
    <view class="time-section">
      <view class="section-title">é€‰æ‹©é¢„çº¦æ—¶é—´</view>
      
      <!-- æ—¥æœŸé€‰æ‹© -->
      <scroll-view class="date-scroll" scroll-x="true">
        <view 
          class="date-item {{currentDate === item.date ? 'active' : ''}} {{item.isPast ? 'disabled' : ''}}"
          wx:for="{{dateList}}"
          wx:key="date"
          bindtap="onDateSelect"
          data-date="{{item.date}}"
          data-index="{{index}}">
          <view class="date-day">{{item.day}}</view>
          <view class="date-week">{{item.week}}</view>
        </view>
      </scroll-view>
      
      <!-- æ—¶é—´æ®µåŠ è½½çŠ¶æ€ -->
      <view class="time-slots-loading" wx:if="{{timeSlotsLoading}}">
        <view class="loading-spinner-small"></view>
        <text class="loading-text-small">åŠ è½½æ—¶é—´æ®µ...</text>
      </view>
      
      <!-- æ—¶é—´æ®µé€‰æ‹© -->
      <scroll-view class="time-scroll" scroll-x="true" wx:else>
        <view 
          class="time-item {{currentTimeSlot === index ? 'active' : ''}} {{item.isFull || item.isPast ? 'disabled' : ''}}"
          wx:for="{{timeSlots}}"
          wx:key="index"
          bindtap="onTimeSelect"
          data-index="{{index}}">
          <view class="time-range">{{item.startTime}}-{{item.endTime}}</view>
          <view class="available-slots">
            <block wx:if="{{item.isFull}}">å·²æ»¡</block>
            <block wx:elif="{{item.isPast}}">å·²è¿‡æœŸ</block>
            <block wx:else>å‰©ä½™{{item.availableSlots}}ä¸ªåé¢</block>
          </view>
        </view>
      </scroll-view>
      
      <!-- é¢„çº¦æŒ‰é’® - ç§»åŠ¨åˆ°æ—¶é—´æ®µé€‰æ‹©ä¸‹æ–¹ -->
      <view class="reserve-btn-container">
        <button 
          class="reserve-btn-inline {{canReserve ? '' : 'disabled'}} {{exhibition.status === 'ended' ? 'ended' : ''}}" 
          bindtap="onReserveTap" 
          disabled="{{!canReserve || exhibition.status === 'ended'}}">
          <block wx:if="{{exhibition.status === 'ended'}}">
            å±•è§ˆå·²ç»“æŸ
          </block>
          <block wx:elif="{{!selectedTimeSlot}}">
            è¯·é€‰æ‹©é¢„çº¦æ—¶é—´
          </block>
          <block wx:elif="{{selectedTimeSlot.isFull}}">
            è¯¥æ—¶æ®µå·²çº¦æ»¡
          </block>
          <block wx:else>
            ç«‹å³é¢„çº¦
          </block>
        </button>
      </view>
    </view>

    <!-- è—å“åˆ—è¡¨åŒº -->
    <view class="collections-section">
      <view class="section-title">ç›¸å…³è—å“</view>
      
      <!-- è—å“ç½‘æ ¼ -->
      <view class="collections-grid">
        <view 
          class="collection-item"
          wx:for="{{collections}}"
          wx:key="id"
          bindtap="onCollectionTap"
          data-id="{{item.id}}">
          <!-- å›¾ç‰‡æ˜¾ç¤ºï¼Œå¢åŠ æ›´å¤šå®¹é”™å¤„ç† -->
          <block wx:if="{{item.picturePath && item.picturePath.indexOf('http') === 0}}">
            <image class="collection-image" src="{{item.picturePath}}" mode="aspectFill"></image>
          </block>
          <block wx:elif="{{item.picturePath}}">
            <image class="collection-image" src="{{baseUrl}}/file/getPic?name={{item.picturePath}}" mode="aspectFill"></image>
          </block>
          <block wx:elif="{{item.colPic}}">
            <image class="collection-image" src="{{baseUrl}}/file/getPic?name={{item.colPic}}" mode="aspectFill"></image>
          </block>
          <block wx:else>
            <view class="collection-image no-image">æš‚æ— å›¾ç‰‡</view>
          </block>
          
          <view class="collection-info">
            <view class="collection-name">{{item.name || item.title}}</view>
            <view class="collection-dynasty">{{item.dynasty || item.origin || 'æœªçŸ¥å¹´ä»£'}}</view>
            <view class="collection-desc" wx:if="{{item.description || item.desColl}}">{{item.description || item.desColl}}</view>
          </view>
        </view>
      </view>
      
      <!-- è—å“åŠ è½½æç¤º - ä¿®æ”¹æ¡ä»¶é€»è¾‘ -->
      <view class="loading" wx:if="{{collectionsLoading}}">åŠ è½½ä¸­...</view>
      <view class="no-more" wx:if="{{!collectionsLoading && collections.length > 0 && !hasMoreCollections}}">æ²¡æœ‰æ›´å¤šè—å“äº†</view>
      <view class="empty" wx:if="{{!collectionsLoading && collections.length === 0}}">
        <!-- ä½¿ç”¨æ–‡æœ¬æ›¿ä»£å›¾æ ‡ -->
        <text class="empty-icon-text">ğŸ”</text>
        <text class="empty-text">æš‚æ— ç›¸å…³è—å“</text>
      </view>
    </view>

    <!-- ç”¨æˆ·è¯„è®ºåŒºåŸŸ -->
    <view class="comment-section">
      <view class="section-title">ç”¨æˆ·è¯„è®º</view>
      <view class="comment-list">
        <view class="comment-item" wx:for="{{comments}}" wx:key="id">
          <view class="comment-header">
            <image class="comment-avatar" src="{{item.avatarUrl || '/images/mine/head.png'}}"></image>
            <view class="comment-user-info">
              <text class="comment-nickname">{{item.userName || 'åšç‰©é¦†æ¸¸å®¢'}}</text>
              <text class="comment-time">{{item.fedDateTime}}</text>
            </view>
          </view>
          <view class="comment-content">{{item.feedContent}}</view>
          <view class="comment-actions">
            <!-- æ·»åŠ åˆ é™¤æŒ‰é’®ï¼Œä»…å½“å½“å‰ç”¨æˆ·IDä¸è¯„è®ºç”¨æˆ·IDåŒ¹é…æ—¶æ˜¾ç¤º -->
            <view class="delete-action" bindtap="onCommentDeleteTap" data-id="{{item.id}}" 
                  wx:if="{{userInfo && userInfo.id && String(userInfo.id) === String(item.userId)}}">
              <image class="delete-icon" src="/images/icons/delete.png"></image>
            </view>
            <view class="like-action" bindtap="onCommentLikeTap" data-id="{{item.id}}">
              <image class="like-icon" src="/images/icons/{{item.isLiked ? 'like-active.png' : 'like.png'}}"></image>
              <text class="like-count">{{item.likeCount || 0}}</text>
            </view>
          </view>
        </view>
        
        <view class="no-comment" wx:if="{{comments.length === 0}}">
          <text>æš‚æ— è¯„è®º</text>
        </view>
      </view>
    </view>
  </block>
</view>

<!-- è¯„è®ºè¾“å…¥æ¡† -->
<view class="comment-input-container">
  <input class="comment-input" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." value="{{commentText}}" bindinput="onCommentInput" />
  <button class="send-btn" bindtap="onCommentSubmit">å‘é€</button>
</view>

<!-- éšç§åè®®å¼¹çª— -->
<privacy-modal show="{{showPrivacyModal}}" 
              bind:agree="onPrivacyAgree"
              bind:reject="onPrivacyReject" />
              
<!-- æ‰‹æœºå·æˆæƒå¼¹çª— -->
<phone-auth-modal show="{{showPhoneModal}}"
                phone-number="{{phoneNumber}}"
                bind:confirm="onPhoneConfirm"
                bind:reject="onPhoneReject"
                bind:useOtherPhone="onUseOtherPhone" /> 